<?xml version="1.0" encoding="ISO8859-1"?>

<project basedir=".." default="all" name="All">

    <target name="init" description="inits the build">

        <property environment="env"/>

		<property name="define.jarfilename"  value="jameica.jar"/>
		<property name="define.package"      value="de.willuhn.jameica"/>

        <property name="build.dir" 			 value="build"/>
		<buildnumber file="${build.dir}/BUILD"/>
	    <loadfile property="version" srcFile="${build.dir}/RELEASE">
	      <filterchain>
	        <striplinebreaks/>
	      </filterchain>
	    </loadfile>

		<echo message="VERSION: ${version}"/>
		<echo message="BUILD  : ${build.number}"/>

        <property name="project.release"	 value="releases/${version}-${build.number}"/>
        <property name="project.src" 		 value="${project.release}/src/classes"/>
        <property name="project.tmp" 		 value="${project.release}/tmp"/>
        <property name="project.javadoc" 	 value="${project.release}/javadoc"/>
        <property name="src.dir" 			 value="src"/>
        <property name="cfg.dir" 			 value="cfg"/>
        <property name="icon.dir" 			 value="${src.dir}/img"/>
        <property name="lang.dir" 			 value="${src.dir}/lang"/>
        <property name="lib.dir" 			 value="lib"/>
        <property name="class.dir" 			 value="${project.tmp}/bin"/>



		<fileset dir="">
			<patternset id="lib.compileset">
				<include name="${lib.dir}/**.jar"/>
				<include name="${lib.dir}/linux/**.*"/>
			</patternset>
		</fileset>

    </target>


    <target depends="init" name="compile" description="compiles everything">

        <mkdir dir="${class.dir}"/>

		<javac fork="true" debug="true" deprecation="true" destdir="${class.dir}" srcdir="${src.dir}">
			<classpath>
				<fileset dir="">
					<patternset refid="lib.compileset"/>
				</fileset>
			</classpath>
        </javac>

        <rmic verify="true" base="${class.dir}">
            <include name="**/*.class"/>
            <classpath>
				<fileset dir="">
					<patternset refid="lib.compileset"/>
				</fileset>
            </classpath>
        </rmic>

        <copydir 	src="${icon.dir}" 					dest="${class.dir}/img"/>
        <copydir 	src="${lang.dir}" 					dest="${class.dir}/lang"/>
        <copyfile 	src="${src.dir}/navigation.xml" 	dest="${class.dir}/navigation.xml"/>
        <copyfile 	src="${src.dir}/menu.xml"	 		dest="${class.dir}/menu.xml"/>

	</target>


	<target depends="compile" name="cvstag" description="tags the source in the CVS">

	    <exec executable="cvs" failonerror="true" dir="${basedir}">
	      <arg line="tag ${version}_BUILD_${build.number}"/>
	    </exec>

	</target>


    <target depends="compile" name="jar" description="generates the jar file">

        <mkdir dir="${project.release}"/>

	    <jar destfile="${project.release}/${define.jarfilename}">
		    <manifest>
		    	<attribute name="Built-By" value="${user.name}"/>
		    	<attribute name="Implementation-Title" value="${define.package}"/>
		    	<attribute name="Implementation-Version" value="${version}"/>
		    	<attribute name="Implementation-Buildnumber" value="${build.number}"/>
		    	<attribute name="Main-Class" value="de.willuhn.jameica.Main"/>
		    	<attribute name="Class-Path" value="img lib/bb_util.jar lib/linux/swt.jar lib/linux/swt-pi.jar"/>
		    </manifest>
		    <fileset dir="${class.dir}"/>
		</jar>
		
		<mkdir dir="${project.release}/lib"/>

        <copydir 	src="${cfg.dir}" 					dest="${project.release}/cfg"/>

		<copy todir="${project.release}/lib">
			<fileset dir="${lib.dir}"/>
		</copy>

		<copy file="${build.dir}/jameica.sh" tofile="${project.release}/jameica.sh" />
		<copy file="${build.dir}/jameicaserver.sh" tofile="${project.release}/jameicaserver.sh" />

    </target>

    <target depends="jar" name="javadoc" description="creates the api doc">

        <mkdir dir="${project.javadoc}"/>

        <javadoc destdir="${project.javadoc}" packagenames="${define.package}.*">
			<classpath>
				<fileset dir="">
					<patternset refid="lib.compileset"/>
				</fileset>
			</classpath>
            <sourcepath>
                <pathelement location="${src.dir}"/>
            </sourcepath>
        </javadoc>

    </target>

    <target name="clean" description="cleanup">
        <delete dir="${project.tmp}"/>
    </target>


    <target depends="init,compile,cvstag,jar,javadoc,clean" description="build an official release" name="all" />

    <target depends="init,compile,jar,clean" description="build inofficial release" name="fast" />

</project>
