<?xml version="1.0" encoding="ISO-8859-1"?>

<!--
 $Revision: 1.60 $
 $Date: 2008/12/30 15:46:49 $
 $Author: willuhn $
 
 All rights reserved
-->

<project basedir=".." default="all" name="All">


	<target name="init" description="inits the build">

		<property environment="env" />

		<property name="build.dir" value="build" />

		<!-- read build number -->
		<buildnumber file="${build.dir}/BUILD" />

		<!-- read version number -->
		<loadfile property="appversion" srcFile="${build.dir}/RELEASE">
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<loadproperties srcFile="${build.dir}/build.properties"/>

		<!-- prepare cvs tag -->
		<copy file="${build.dir}/RELEASE" tofile="${build.dir}/TAG" />
		<replaceregexp flags="g" file="${build.dir}/TAG" match="\." replace="_" />
		<loadfile property="mytag" srcFile="${build.dir}/TAG">
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>

		<delete file="${build.dir}/TAG" />
		<property name="tag" value="V_${mytag}_BUILD_${build.number}" />

		<echo message="VERSION: ${appversion}" />
		<echo message="CVS-Tag: ${tag}" />
		<echo message="BUILD  : ${build.number}" />
		<echo message="JAVA   : ${java.version}" />

		<path id="compilepath">
			<fileset dir="lib">
				<include name="**/*.jar" />
			</fileset>
		</path>
	</target>

	<target depends="init" name="cvs" description="performs cvs update">
		<exec executable="cvs" failonerror="true" dir="${basedir}">
			<arg line="update -dP" />
		</exec>
	</target>



	<target depends="init" name="compile" description="compiles everything">

		<mkdir dir="${class.dir}" />

		<javac debug="true" debuglevel="lines,vars,source" source="1.5" target="1.5" encoding="${define.encoding}" deprecation="true" destdir="${class.dir}" srcdir="${src.dir}">
			<classpath refid="compilepath" />
		</javac>

		<copy todir="${class.dir}/img">
			<fileset dir="${icon.dir}" />
		</copy>
		<copy todir="${class.dir}/lang">
			<fileset dir="${lang.dir}" />
		</copy>
		<copy todir="${class.dir}/help">
			<fileset dir="${help.dir}" />
		</copy>
	</target>



	<target depends="compile" name="cvstag" description="tags the source in the CVS">

		<exec executable="cvs" failonerror="true" dir="${basedir}">
			<arg line="tag ${tag}" />
		</exec>

	</target>


	<target depends="compile" name="jar" description="generates the jar files">

		<mkdir dir="${project.release}" />
		<mkdir dir="${project.zipdir}" />

		<tstamp/>

		<jar destfile="${project.zipdir}/${define.jarfilename}">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${DSTAMP}" />
				<attribute name="Implementation-Title" value="${define.projectname}" />
				<attribute name="Implementation-Version" value="${appversion}" />
				<attribute name="Implementation-Buildnumber" value="${build.number}" />
			</manifest>
			<fileset dir="${class.dir}" />
		</jar>


		<jar destfile="${project.zipdir}/${define.jarfilename.linux}">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${DSTAMP}" />
				<attribute name="Implementation-Title" value="${define.projectname}" />
				<attribute name="Implementation-Version" value="${appversion}" />
				<attribute name="Implementation-Buildnumber" value="${build.number}" />
				<attribute name="Main-Class" value="de.willuhn.jameica.Main" />
				<attribute name="Class-Path" value="${classpath.linux}" />
			</manifest>
			<fileset dir="${class.dir}" includes="**/Main.class" />
		</jar>

		<jar destfile="${project.zipdir}/${define.jarfilename.macos}">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${DSTAMP}" />
				<attribute name="Implementation-Title" value="${define.projectname}" />
				<attribute name="Implementation-Version" value="${appversion}" />
				<attribute name="Implementation-Buildnumber" value="${build.number}" />
				<attribute name="Main-Class" value="de.willuhn.jameica.Main" />
				<attribute name="Class-Path" value="${classpath.macos}" />
			</manifest>
			<fileset dir="${class.dir}" includes="**/Main.class" />
		</jar>

    <jar destfile="${project.zipdir}/${define.jarfilename.openbsd}">
      <manifest>
        <attribute name="Built-By" value="${user.name}" />
        <attribute name="Built-Date" value="${DSTAMP}" />
        <attribute name="Implementation-Title" value="${define.projectname}" />
        <attribute name="Implementation-Version" value="${appversion}" />
        <attribute name="Implementation-Buildnumber" value="${build.number}" />
        <attribute name="Main-Class" value="de.willuhn.jameica.Main" />
        <attribute name="Class-Path" value="${classpath.openbsd}" />
      </manifest>
      <fileset dir="${class.dir}" includes="**/Main.class" />
    </jar>

    <jar destfile="${project.zipdir}/${define.jarfilename.linux-amd64}">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${DSTAMP}" />
				<attribute name="Implementation-Title" value="${define.projectname}" />
				<attribute name="Implementation-Version" value="${appversion}" />
				<attribute name="Implementation-Buildnumber" value="${build.number}" />
				<attribute name="Main-Class" value="de.willuhn.jameica.Main" />
				<attribute name="Class-Path" value="${classpath.linux-amd64}" />
			</manifest>
			<fileset dir="${class.dir}" includes="**/Main.class" />
		</jar>

		<jar destfile="${project.zipdir}/${define.jarfilename.win32}">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${DSTAMP}" />
				<attribute name="Implementation-Title" value="${define.projectname}" />
				<attribute name="Implementation-Version" value="${appversion}" />
				<attribute name="Implementation-Buildnumber" value="${build.number}" />
				<attribute name="Main-Class" value="de.willuhn.jameica.Main" />
				<attribute name="Class-Path" value="${classpath.win32}" />
			</manifest>
			<fileset dir="${class.dir}" includes="**/Main.class" />
		</jar>
  </target>
  
  <target depends="jar" name="signjar" description="signs the zip files">
    <loadfile property="storepass" srcFile="${signjar.storepass}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename.linux}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename.linux-amd64}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename.macos}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename.openbsd}"/>
    <signjar alias="${signjar.alias}" storepass="${storepass}" keystore="${signjar.keystore}" verbose="true" jar="${project.zipdir}/${define.jarfilename.win32}"/>
  </target>

  <target depends="jar" name="zip" description="generates the zip files">

    <mkdir dir="${project.zipdir}/lib" />
		<mkdir dir="${project.zipdir}/plugins" />

		<copy todir="${project.zipdir}/lib">
			<fileset dir="lib" />
		</copy>

		<copy todir="${project.zipdir}">
			<fileset dir="${build.dir}">
				<include name="*.sh"/>
				<include name="*.bat"/>
				<include name="rcjameica"/>
				<include name="jameica-icon-01.png"/>
        <include name="jameica-icon-02.png"/>
				<include name="COPYING"/>
				<include name="README"/>
        <include name="Jameica.icns"/>
        <include name="Info.plist"/>
			</fileset>
		</copy>
    <copy file="plugin.xml" todir="${project.zipdir}" />

		<!-- ZIP-File fuer Linux -->
		<zip destfile="${project.release}/${project.zipfilename.linux}">
			<zipfileset dir="${project.release}" filemode="755">
				<include name="${define.projectname}" />
        <include name="${define.projectname}/plugin.xml"/>
				<include name="${define.projectname}/${define.jarfilename}"/>
				<include name="${define.projectname}/${define.jarfilename.linux}"/>
				<include name="${define.projectname}/COPYING"/>
				<include name="${define.projectname}/README"/>
				<include name="${define.projectname}/jameica.sh"/>
				<include name="${define.projectname}/jameicaserver.sh"/>
				<include name="${define.projectname}/rcjameica"/>
				<include name="${define.projectname}/jameica-icon-01.png"/>
        <include name="${define.projectname}/jameica-icon-02.png"/>
				<include name="${define.projectname}/plugins"/>
				<include name="${define.projectname}/lib/**"/>

        <exclude name="${define.projectname}/lib/swt/openbsd/**"/>
				<exclude name="${define.projectname}/lib/swt/win32/**"/>
				<exclude name="${define.projectname}/lib/swt/macos/**"/>
				<exclude name="${define.projectname}/lib/swt/linux-amd64/**"/>
        <exclude name="${define.projectname}/Jameica.icns"/>
        <exclude name="${define.projectname}/Info.plist"/>
			</zipfileset>
		</zip>

		<!-- ZIP-File fuer Linux AMD 64 -->
		<zip destfile="${project.release}/${project.zipfilename.linux-amd64}">
			<zipfileset dir="${project.release}" filemode="755">
				<include name="${define.projectname}" />
        <include name="${define.projectname}/plugin.xml"/>
				<include name="${define.projectname}/${define.jarfilename}"/>
				<include name="${define.projectname}/${define.jarfilename.linux-amd64}"/>
				<include name="${define.projectname}/COPYING"/>
				<include name="${define.projectname}/README"/>
				<include name="${define.projectname}/jameica-amd64.sh"/>
				<include name="${define.projectname}/jameicaserver-amd64.sh"/>
				<include name="${define.projectname}/rcjameica"/>
        <include name="${define.projectname}/jameica-icon-01.png"/>
        <include name="${define.projectname}/jameica-icon-02.png"/>
				<include name="${define.projectname}/plugins"/>
				<include name="${define.projectname}/lib/**"/>

        <exclude name="${define.projectname}/lib/swt/openbsd/**"/>
				<exclude name="${define.projectname}/lib/swt/win32/**"/>
				<exclude name="${define.projectname}/lib/swt/macos/**"/>
				<exclude name="${define.projectname}/lib/swt/linux/**"/>
        <exclude name="${define.projectname}/Jameica.icns"/>
        <exclude name="${define.projectname}/Info.plist"/>
			</zipfileset>
		</zip>

		<!-- ZIP-File fuer Win32 -->
		<zip destfile="${project.release}/${project.zipfilename.win32}">
			<zipfileset dir="${project.release}" filemode="755">
				<include name="${define.projectname}" />
        <include name="${define.projectname}/plugin.xml"/>
				<include name="${define.projectname}/${define.jarfilename}"/>
				<include name="${define.projectname}/${define.jarfilename.win32}"/>
				<include name="${define.projectname}/COPYING"/>
				<include name="${define.projectname}/README"/>
				<include name="${define.projectname}/jameica.bat"/>
				<include name="${define.projectname}/jameicaserver.bat"/>
        <include name="${define.projectname}/jameica-icon-01.png"/>
        <include name="${define.projectname}/jameica-icon-02.png"/>
				<include name="${define.projectname}/plugins"/>
				<include name="${define.projectname}/lib/**"/>

        <exclude name="${define.projectname}/lib/swt/openbsd/**"/>
				<exclude name="${define.projectname}/lib/swt/macos/**"/>
				<exclude name="${define.projectname}/lib/swt/linux/**"/>
				<exclude name="${define.projectname}/lib/swt/linux-amd64/**"/>
        <exclude name="${define.projectname}/Jameica.icns"/>
        <exclude name="${define.projectname}/Info.plist"/>
			</zipfileset>
		</zip>

		<!-- ZIP-File fuer MacOS -->
    <mkdir dir="${project.tmp}/${define.projectname}.app" />
    <copy todir="${project.tmp}/${define.projectname}.app">
      <fileset dir="${project.release}/${define.projectname}">
        <include name="plugin.xml"/>
        <include name="${define.jarfilename}"/>
        <include name="${define.jarfilename.macos}"/>
        <include name="COPYING"/>
        <include name="README"/>
        <include name="Jameica.icns"/>
        <include name="Info.plist"/>
        <include name="jameica-macos.sh"/>
        <include name="jameicaserver-macos.sh"/>
        <include name="rcjameica"/>
        <include name="jameica-icon-01.png"/>
        <include name="jameica-icon-02.png"/>
        <include name="plugins"/>
        <include name="lib/**"/>
        <exclude name="lib/swt/openbsd/**"/>
        <exclude name="lib/swt/win32/**"/>
        <exclude name="lib/swt/linux/**"/>
        <exclude name="lib/swt/linux-amd64/**"/>
      </fileset>
    </copy>
		<zip destfile="${project.release}/${project.zipfilename.macos}">
      <zipfileset dir="${project.tmp}" filemode="755">
        <include name="${define.projectname}.app/**"/>
      </zipfileset>
		</zip>

    <!-- ZIP-File fuer OpenBSD -->
    <zip destfile="${project.release}/${project.zipfilename.openbsd}">
      <zipfileset dir="${project.release}" filemode="755">
        <include name="${define.projectname}" />
        <include name="${define.projectname}/plugin.xml"/>
        <include name="${define.projectname}/${define.jarfilename}"/>
        <include name="${define.projectname}/${define.jarfilename.openbsd}"/>
        <include name="${define.projectname}/COPYING"/>
        <include name="${define.projectname}/README"/>
        <include name="${define.projectname}/jameica-openbsd.sh"/>
        <include name="${define.projectname}/jameicaserver-openbsd.sh"/>
        <include name="${define.projectname}/rcjameica"/>
        <include name="${define.projectname}/jameica-icon-01.png"/>
        <include name="${define.projectname}/jameica-icon-02.png"/>
        <include name="${define.projectname}/plugins"/>
        <include name="${define.projectname}/lib/**"/>

        <exclude name="${define.projectname}/lib/swt/macos/**"/>
        <exclude name="${define.projectname}/lib/swt/win32/**"/>
        <exclude name="${define.projectname}/lib/swt/linux/**"/>
        <exclude name="${define.projectname}/lib/swt/linux-amd64/**"/>
        <exclude name="${define.projectname}/Jameica.icns"/>
        <exclude name="${define.projectname}/Info.plist"/>
      </zipfileset>
    </zip>

    <!-- ZIP-File mit allen Betriebssystemen -->
		<zip destfile="${project.release}/${project.zipfilename}">
			<zipfileset dir="${project.release}" filemode="755">
				<include name="${define.projectname}" />
				<include name="${define.projectname}/**" />
			</zipfileset>
		</zip>


	</target>


	<target depends="compile" name="src" description="build source package, depends compile target to make sure, the code has no errors">
		<mkdir dir="${project.release}" />
		<mkdir dir="${project.tmp}/${define.projectname}" />
		<copy todir="${project.tmp}/${define.projectname}">
			<fileset dir=".">
				<include name=".project" />
				<include name=".classpath" />
        <include name="plugin.xml" />
				<include name="lib/**" />
				<include name="${src.dir}/**" />
				<include name="${build.dir}/**" />
				<exclude name="${build.dir}/BUILD" />
			</fileset>
		</copy>
		<zip casesensitive="true" zipfile="${project.release}/${define.srcfilename}">
			<fileset dir="${project.tmp}">
				<include name="${define.projectname}/**" />
			</fileset>
		</zip>
	</target>

	<target depends="compile" name="javadoc" description="creates the api doc">

		<mkdir dir="${project.javadoc}" />

		<javadoc charset="${define.encoding}" docencoding="${define.encoding}" encoding="${define.encoding}"
             destdir="${project.javadoc}" packagenames="${define.package}.*">
			<classpath refid="compilepath" />
			<sourcepath>
				<pathelement location="${src.dir}" />
			</sourcepath>
		</javadoc>

		<zip casesensitive="true" zipfile="${project.release}/${define.javadocfilename}">
			<fileset dir="${project.javadoc}">
				<include name="**" />
			</fileset>
		</zip>

	</target>


	<target name="clean" description="cleanup">
		<delete dir="${project.tmp}" />
		<delete dir="${project.zipdir}" />
		<delete dir="${project.javadoc}" />
	</target>


	<target name="sign" description="signs the jar/zip file">
		<checksum file="${project.release}/${define.srcfilename}" />
		<checksum file="${project.release}/${project.zipfilename}" />
		<checksum file="${project.release}/${project.zipfilename.win32}" />
		<checksum file="${project.release}/${project.zipfilename.linux}" />
		<checksum file="${project.release}/${project.zipfilename.linux-amd64}" />
		<checksum file="${project.release}/${project.zipfilename.macos}" />
    <checksum file="${project.release}/${project.zipfilename.openbsd}" />
		<echo message="Creating PGP signatures" />

		<exec executable="gpg" failonerror="true" timeout="60000">
			<arg line="-asb --use-agent ${project.release}/${define.srcfilename}" />
		</exec>

		<exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename}" />
		</exec>
		<exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename.win32}" />
		</exec>
		<exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename.linux}" />
		</exec>
		<exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename.linux-amd64}" />
		</exec>
		<exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename.macos}" />
		</exec>
    <exec executable="gpg" failonerror="true" timeout="60000">
      <arg line="-asb --use-agent ${project.release}/${project.zipfilename.openbsd}" />
    </exec>
	</target>


	<target depends="init,compile,cvstag,jar,signjar,zip,javadoc,src,sign,clean" description="build an official release" name="all" />

	<target depends="init,compile,jar,zip,src,clean" description="build inofficial release" name="fast" />

	<target depends="init,cvs,compile,jar,zip,javadoc,src" description="build nightly build" name="nightly">
		<mkdir dir="${project.nightly}" />

		<copy file="${project.release}/${project.zipfilename}" 				      tofile="${project.nightly}/${define.projectname}-${appversion}.zip" />
		<copy file="${project.release}/${project.zipfilename.linux}" 		    tofile="${project.nightly}/${define.projectname}-${appversion}-linux.zip" />
		<copy file="${project.release}/${project.zipfilename.linux-amd64}" 	tofile="${project.nightly}/${define.projectname}-${appversion}-linux-amd64.zip" />
		<copy file="${project.release}/${project.zipfilename.macos}" 		    tofile="${project.nightly}/${define.projectname}-${appversion}-macos.zip" />
		<copy file="${project.release}/${project.zipfilename.win32}" 		    tofile="${project.nightly}/${define.projectname}-${appversion}-win32.zip" />
    <copy file="${project.release}/${project.zipfilename.openbsd}"      tofile="${project.nightly}/${define.projectname}-${appversion}-openbsd.zip" />


		<copy file="${project.release}/${define.srcfilename}" 		          tofile="${project.nightly}/${define.projectname}-${appversion}.src.zip" />
		<copy file="${project.release}/${define.javadocfilename}" 	        tofile="${project.nightly}/${define.projectname}-${appversion}.javadoc.zip" />

		<!-- Die Datei brauchen die anderen Plugins zum Kompilieren //-->
		<copy file="${project.zipdir}/${define.jarfilename}" tofile="releases/jameica-lib.jar" />

		<delete dir="${project.release}" />
	</target>


</project>
